# 网络协议

# 1. 概述

HTTP/1.0 ，一次只能处理一个TCP请求。 HTTP/1.1 ，对于TCP请求添加了管道，解决了部分并发问题，但是会遭遇 head-of-line 阻塞。因此这两个版本的客户端需要多并发创建连接保证连接的稳定性和低延迟性。此外，HTTP的头部通常是重复和冗余的，会占用网络资源，同时加速填满TCP拥堵窗口 。

HTTP/2 解决了上述问题，数据单元是 帧，每一帧的类型服务不同的目的。

frame：连接的最小的通讯单元，由header和可变长度序列组成根据帧类型构造的**八位字节**

stream：HTTP/2 连接中的双向帧流

# 2. 开始HTTP/2

HTTP2连接是运行在顶部应用层协议的TCP连接，对**HTTP**使用默认的**80**端口，对**HTTPS**使用默认的**443**端口。实现者在处理类似 http://example.org/foo 或 https://example.com/bar 这样 URI 的目标资源请求之前，需要首先确定上游服务端（即当前客户端希望直接与之建立连接的对端）是否支持 HTTP/2。

两个协议标示符：

- h2，标示使用了 TLS(Transport Layer Security)*[TLS12]* 的 HTTP/2 协议。该标识符用在 TLS-ALPN(application-layer protocol negotiation)*[TLS-ALPN]* 的扩展字段，以及其他需要标示运行于 TLS 之上 HTTP/2 的地方。
- h2c，标示运行在明文 TCP 之上的 HTTP/2 协议。该标识符用在 HTTP/1.1 的 Upgrade 首部字段，以及其他需要标示运行于 TCP 之上 HTTP/2 的地方。

假如一个客户端不知道服务器支不支持HTTP/2，就可以先使用HTTP/1的请求，在Upgrade字段填上 h2c字段。

```txt
GET / HTTP/1.1
Host: server.example.com
Connection: Upgrade, HTTP2-Settings
Upgrade: h2c
HTTP2-Settings: <base64url encoding of HTTP/2 SETTINGS payload>
```

不支持HTTP/2请求的服务器会忽视Upgrade字段

支持HTTP/2的服务器会返回 101 的状态相应码，表示接收升级协议请求。在结束101空行响应后，服务器开始发送HTTP/2帧。

```txt
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: h2c

[ HTTP/2 connection ...
```

# 3. 数据帧的格式

```txt
+-----------------------------------------------+
|                 Length (24)                   |
+---------------+---------------+---------------+
|   Type (8)    |   Flags (8)   |
+-+-------------+---------------+-------------------------------+
|R|                 Stream Identifier (31)                      |
+=+=============================================================+
|                   Frame Payload (0...)                      ...
+---------------------------------------------------------------+
```

报头部分的字段定义如下:

- `Length`: 载荷的长度, 无符号24位整型. **对于发送值大于2^14 (长度大于16384字节)的载荷, 只有在接收方设置`SETTINGS_MAX_FRAME_SIZE`为更大的值时才被允许**

  注: 帧的报头9字节不算在length里.

- `Type`: 8位的值表示帧类型, 决定了帧的格式和语义. 协议实现上必须忽略任何未知类型的帧.

- `Flags`: 为Type保留的bool标识, 大小是8位. 对确定的帧类型赋予特定的语义, 否则发送时必须忽略(设置为0x0).

- `R`: 1位的保留字段, 尚未定义语义. 发送和接收必须忽略(0x0).

- `Stream Identifier`: 31位无符号整型的流标示符. 其中0x0作为保留值, 表示与连接相关的frames作为一个整体而不是一个单独的流.



第五节（stream）

第六节（Frame）

第七节（error）

第八节（HTTP mapping）

第九节（额外要求）

# 2.HTTPS协议