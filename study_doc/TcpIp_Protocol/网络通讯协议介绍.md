# 网络通讯协议介绍

# 1. ARP协议

## 1.1 简单介绍

(Address Resolution Protocol)地址解析协议，根据IP地址获取物理地址的一个TCP/IP协议。主机发送信息时包含**目标IP地址的ARP请求**广播到局域网络上的所有主机，并接收返回消息，以此确定目标的物理地址；收到返回消息后**将该IP地址和物理地址存入本机ARP缓存**中并保留一定时间，下次请求时直接查询ARP缓存以节约资源。

地址解析协议是建立在网络中各个主机互相信任的基础上的，**局域网络**上的主机可以自主发送ARP应答消息，其他主机收到应答报文时**不会检测该报文的真实性**就会将其记入本机ARP缓存；

## 1.2 ARP工作过程

（ARP请求的等到时间为5秒钟）

**主机A和B在同一个网段**，主机A要向主机B发送数据，解析过程如下：

1. 主机A首先查看自己的ARP缓存表，确定其中是否包含主机B对应的ARP表项。如果找到了对应的MAC地址，则主机A直接利用ARP表中的**MAC地址**，对IP数据包进行帧封装，并将数据包发送给主机B；
2. 如果主机A在ARP表中找不到对应的MAC地址，则将缓存该数据报文，然后以广播形式发送一个ARP请求报文。请求报文中的**发送端IP地址和发送端MAC地址为主机A的IP地址和MAC地址**，**目标IP地址为主机B的地址和目标MAC地址为<u>全0的MAC地址</u>**。该网段上所有主机都可以接收到该请求，但是只有被请求的B会对该请求进行处理。
3. 主机B比较自己的IP地址和ARP请求报文中的目标地址，当两者相同时进行如下处理：将ARP请求报文中的发送端（即主机A）的IP地址和MAC地址存入自己的ARP表中。之后以单播方式发送ARP相应报文给主机A，其中包含自己的MAXC地址
4. 主机A收到ARP相应报文后，将主机B的MAC地址加入到自己的ARP表中以用于后续报文的转发，同事将IP数据包进行封装后发送

**主机A和主机B不在同一个网段**

1. 主机A会先向网关发出ARP请求，ARP请求报文中的目标地址为网关的IP地址。
2. 当主机A从收到的相应报文中获取网关的MAC地址后，将报文封装并发给网关。
3. 如果网关没有主机B的ARP项，网关会广播ARP请求，目标IP地址为主机B的IP地址，当网关从收到的相应报文中获取到主机B的MAC地址后，就可以将报文发送给主机B
4. 如果网关有主机B的ARP表项，则直接将报文发送给主机B

## 1.3 ARP表

存放IP地址和MAC地址的关联信息。

IP地址和MAC地址的映射关系在ARP缓存表中存放一段时间。在有效期内，设备可以直接从这个表中查找目的MAC地址来进行数据封装，而无需进行ARP查询。过了这段有效期，ARP表现会被自动删除。

如果目标设备位于其他网络则源设备会在ARP缓存表中查找网关的MAC地址，然后将数据发送给网关，网关再把数据转发给目的设备。

### 1.3.1 动态ARP表

动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，可以被静态ARP表项覆盖。每个动态ARP缓存项的潜在生命周期是10分钟。

新加到缓存中的项目带有时间戳，如果某个项目添加后2分钟内没有再使用，则此项目过期并从ARP缓存中删除；如果某个项目已在使用，则又收到2分钟的生命周期；如果某个项目始终在使用，则会另外收到2分钟的生命周期，一直到10分钟的最长生命周期。

### 1.3.2 静态ARP表

静态ARP表项通过手工配置和维护，不会被老化，不会被动态ARP表项覆盖。直到重新启动计算机为止。

配置静态ARP表项可以增加通信的安全性。静态ARP表项可以限制和指定IP地址的设备通信时只使用指定的MAC地址，此时攻击报文无法修改此表项的IP地址和MAC地址的映射关系，从而保护了本设备和指定设备间的正常通信。

## 1.4 ARP请求报文格式

|     2     |       2        |      1      |      1      |     2      |     6     |    4     |      6      |     4      |
| :-------: | :------------: | :---------: | :---------: | :--------: | :-------: | :------: | :---------: | :--------: |
| 硬件类型  |  上层协议类型  | MAC地址长度 | IP地址长度  | 操作类型op | 源MAC地址 | 源IP地址 | 目的MAC地址 | 目的IP地址 |
| \|<------ | -------------- |   ARP报头   | ----------- | ------->\| |           |          |             |            |

# 2. IP/ICMP协议

## 2.1 IP 协议

IP协议是TCP/UDP协议族中最核心的协议。IP协议提供不可靠无连接的数据传送。

不可靠：不保证IP数据报能成功地到达目的地。

无连接：IP不维护任何关于后续数据报的状态信息。

![image-20220225151233959](E:\lcsprogram\study_doc\TcpIp_Protocol\images\IP协议报文格式.png)

# 3. TCP/UDP协议

# 4. DNS/HTTP/HTTPS协议

# 5. Session/Cookie